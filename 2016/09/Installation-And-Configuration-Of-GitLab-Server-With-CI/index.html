<!DOCTYPE html><html lang="en"><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description"><meta name="twitter:card" content="summary"><meta name="twitter:site" content="@coderuse"><meta name="twitter:title" content="Installation And Configuration Of GitLab Server With CI"><meta name="twitter:description" content="&lt;p&gt;Please select &lt;a href=&quot;http://releases.ubuntu.com/16.04/&quot; target=&quot;_blank&quot; rel=&quot;external&quot;&gt;Ubuntu 16.04&lt;/a&gt;, if it’s possible, as the server os, for both the servers. I’m using this. I’ll try to write the steps as os agnostic as possible and shall try to give proper links to install for other distributions.&lt;/p&gt;"><meta name="twitter:image" content="https://gitlab.com/gitlab-com/gitlab-artwork/raw/master/wordmark/stacked_wm.png"><title>Installation And Configuration Of GitLab Server With CI | CodeRuse</title><link rel="stylesheet" type="text/css" href="//fonts.googleapis.com/css?family=Open+Sans:300|Roboto:300|Inconsolata"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"><link rel="amphtml" href="./amp/index.html"><link rel="alternate" type="application/atom+xml" href="/atom.xml"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">CodeRuse</a><!--span.subtitle= config.subtitle--><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><div id="top-nav" class="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" target="_blank" class="sidebar-nav-item">Archives</a><a href="http://galleries.coderuse.com" target="_blank" class="sidebar-nav-item">Galleries</a><a href="/about" target="_blank" class="sidebar-nav-item">About</a></div></div><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Installation And Configuration Of GitLab Server With CI</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">Sep 17, 2016</div><div class="post-categories"><a class="post-category-link" href="/categories/CI/">CI</a>><a class="post-category-link" href="/categories/CI/Cookbook/">Cookbook</a>><a class="post-category-link" href="/categories/CI/Cookbook/System/">System</a>><a class="post-category-link" href="/categories/CI/Cookbook/System/Technical/">Technical</a>><a class="post-category-link" href="/categories/CI/Cookbook/System/Technical/Economical/">Economical</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/ci/">ci</a>/<a class="post-tag-link" href="/tags/gitlab/">gitlab</a>/<a class="post-tag-link" href="/tags/private-git/">private-git</a></div></div></div><article><div class="container post"><p>Please select <a href="http://releases.ubuntu.com/16.04/" target="_blank" rel="external">Ubuntu 16.04</a>, if it’s possible, as the server os, for both the servers. I’m using this. I’ll try to write the steps as os agnostic as possible and shall try to give proper links to install for other distributions.</p>
<p>And of-course put the domain/sub-domain name you are going to use as the name of the server. It’s required.</p>
<blockquote>
<p>This is the second part of the series to configure a source control hosting. This post contains only installation steps. If you need any push to motivate youself to do this, you may find the first part helpful.</p>
<p><a href="/2016/09/How-I-Host-Private-GitLab-With-CI-For-Less-Than-Four-Euro/">Here</a> is the first part, regarding choice of hosting and some inspiration.</p>
</blockquote>
<p>I’ve used the <a href="https://docs.gitlab.com/omnibus/" target="_blank" rel="external">Omnibus</a> package for installation. Found this as most convenient one. And I’ve seen that, it’s possible to tweak all the services installed by this package. You can also opt for installation of individual components of GitLab. You can find lot of options <a href="https://about.gitlab.com/installation/" target="_blank" rel="external">here</a>.</p>
<p>Before we start the installation, we need to log into the system by SSH and update our system. If you’re using any version of Linux or Mac, you have your terminal and the command <code>ssh</code> is available. For Windows use <a href="http://www.putty.org/" target="_blank" rel="external">Putty</a>. <a href="http://www.wikihow.com/Use-SSH" target="_blank" rel="external">More details</a>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># first update the registry</span></span><br><span class="line">sudo apt-get update</span><br><span class="line"><span class="comment"># upgrade if any update available</span></span><br><span class="line">sudo apt-get upgrade</span><br></pre></td></tr></table></figure>
<p>Now follow the instructions described <a href="https://about.gitlab.com/downloads" target="_blank" rel="external">here</a> for <a href="https://about.gitlab.com/features/" target="_blank" rel="external">GitLab Community Edition Server</a>. Instructions have been written quite clearly.</p>
<blockquote>
<p>Select <code>Internet Site</code> during Postfix installation</p>
</blockquote>
<p>It may happen that, your server provider has blocked the SMTP port by default. Check if mails are going from the server.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get install mailutils</span><br><span class="line"><span class="built_in">echo</span> <span class="string">"This is the body of the email"</span> | mail <span class="operator">-s</span> <span class="string">"This is the subject line"</span> to@existingmail.address</span><br></pre></td></tr></table></figure>
<p>If not, configure the mail server properly. It’ll be needed by GitLab.</p>
<p>But before executing the command <code>gitlab-ctl reconfigure</code>, we have to do something to configure this server with SSL.</p>
<p>Please don’t use the server with IP. Use a domain name with SSL. It’ll give a level of security inside the network layer. <a href="https://www.sslshopper.com/why-ssl-the-purpose-of-using-ssl-certificates.html" target="_blank" rel="external">More details</a>.</p>
<p>Theoretically you can use a IP for your server hostname. But, if you are configuring a git server for yourself. Give it a name. Even a subdomain like <code>subdomain.domain.tld</code> looks good. And there are lots of providers selling cheap ssl certificates. Get one of them. I’ve seen <a href="https://comodosslstore.com/promoads/cheap-comodo-ssl.aspx" target="_blank" rel="external">Comodo Positive SSL’s</a> are the cheapest ones and will show a green lock in the address bar of the browser.</p>
<p>It’s also possible to use self-signed certificate. But that will show a red lock with cross in the address bar. Main difference will be the <code>.crt</code> certificate we are going to use for the server. To configure SSL for an HTTP server we need one <code>.key</code> and corresponding <code>.crt</code> file. Details about private keys and csr’s are described <a href="https://www.digitalocean.com/community/tutorials/openssl-essentials-working-with-ssl-certificates-private-keys-and-csrs" target="_blank" rel="external">here</a>. To summerize, for self issued certificate, first generate a private key and a <code>.crt</code> file.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># replace the domain with a name you like</span></span><br><span class="line">openssl req \</span><br><span class="line">       -newkey rsa:<span class="number">2048</span> -nodes -keyout domain.key \</span><br><span class="line">       -x509 -days <span class="number">365</span> -out ssl.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># put the files into proper folder so that GitLab can get them</span></span><br><span class="line">sudo mkdir -p /etc/gitlab/ssl</span><br><span class="line">sudo chmod <span class="number">700</span> /etc/gitlab/ssl</span><br><span class="line">sudo cp domain.key ssl.crt /etc/gitlab/ssl/ </span><br><span class="line"></span><br><span class="line"><span class="comment"># also add the keys to the system</span></span><br><span class="line">sudo cp ssl.crt /etc/ssl/certs/gitlab.pem</span><br><span class="line">sudo cat /etc/ssl/certs/gitlab.pem &gt; /etc/ssl/certs/ca-certificates.crt</span><br></pre></td></tr></table></figure>
<p>If you’ve bought a SSL certificate from a provider like Comodo, you need one <code>.csr</code> file to upload to the site to issue a <code>domain validated certificate</code>.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">openssl req \</span><br><span class="line">       -newkey rsa:<span class="number">2048</span> -nodes -keyout domain.key \</span><br><span class="line">       -out domain.csr</span><br></pre></td></tr></table></figure>
<p>Upload the <code>.csr</code> file to the site and after validation/completion of the required steps you can download a <code>.zip</code> file containing either two files like <code>domain.crt</code> and  something like <code>domain-bundle.crt</code> or 4 files, such as <code>domain.crt</code>, <code>AddTrustExternalCARoot.crt</code>, <code>COMODORSAAddTrustCA.crt</code> and <code>COMODORSADomainValidationSecureServerCA.crt</code>. This is the case of Comodo Positive SSL. If you find it otherwise, please consider your SSL issuer’s document about this.</p>
<p>Either way, you need to concatenate all the <code>.crt</code> files into one.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># if you've two .crt files</span></span><br><span class="line">cat domain.crt domain-bundle.crt &gt; ssl.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># if you've four different files</span></span><br><span class="line">cat domain.crt COMODORSADomainValidationSecureServerCA.crt  COMODORSAAddTrustCA.crt AddTrustExternalCARoot.crt &gt; ssl.crt</span><br><span class="line"></span><br><span class="line"><span class="comment"># put the files into proper folder so that GitLab can get them</span></span><br><span class="line">sudo mkdir -p /etc/gitlab/ssl</span><br><span class="line">sudo chmod <span class="number">700</span> /etc/gitlab/ssl</span><br><span class="line">sudo cp domain.key ssl.crt /etc/gitlab/ssl/ </span><br><span class="line"></span><br><span class="line"><span class="comment"># also add the keys to the system</span></span><br><span class="line">sudo cp ssl.crt /etc/ssl/certs/gitlab.pem</span><br><span class="line">sudo cat /etc/ssl/certs/gitlab.pem &gt; /etc/ssl/certs/ca-certificates.crt</span><br></pre></td></tr></table></figure>
<p>To configure your server with the domain name you decided, you have to register the domain name and point the domain to the server or you can use sub-domain of an existing domain. For subdomain create just one <a href="https://en.wikipedia.org/wiki/CNAME_record" target="_blank" rel="external">CNAME</a>. <a href="https://support.google.com/a/answer/47283?hl=en" target="_blank" rel="external">Here</a> you can find some details. Open the generic steps. Use the name you decided for the subdomain as the alias.</p>
<p>To use a root domain like <code>domain.tld</code>, you need to create one A-record and one CNAME record. <a href="https://support.google.com/a/answer/48090?hl=en" target="_blank" rel="external">Here</a>, you can read about various record types for DNS, <a href="https://support.cloudflare.com/hc/en-us/articles/200169096-How-do-I-add-A-records-" target="_blank" rel="external">here</a> is one guide to add A-record and <a href="https://www.digitalocean.com/community/questions/how-to-add-www-record-to-domain" target="_blank" rel="external">here</a>, you will get the details regarding how to point your domain to your server. For that you need to know the IP of the server. Either get it from the mail, you got after buying the server or server provider’s control panel or by the following method, if you are logged into your server by ssh.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line"><span class="comment"># icanhazip is a free service for ip lookup</span></span><br><span class="line">curl http://icanhazip.com</span><br><span class="line">xx.xx.xx.xx <span class="comment"># server ip</span></span><br></pre></td></tr></table></figure>
<p>We are in the last phase of configuration of our GitLab server. Open the file <code>/etc/gitlab/gitlab.rb</code> and add/modify some lines in it. Replace the <code>domain</code> carefully.</p>
<figure class="highlight ruby"><table><tr><td class="code"><pre><span class="line">external_url <span class="string">"https://domain.tld"</span></span><br><span class="line">nginx[<span class="string">'redirect_http_to_https'</span>] = <span class="keyword">true</span></span><br><span class="line">nginx[<span class="string">'ssl_certificate'</span>] = <span class="string">"/etc/gitlab/ssl/ssl.crt"</span></span><br><span class="line">nginx[<span class="string">'ssl_certificate_key'</span>] = <span class="string">"/etc/gitlab/ssl/domain.key"</span></span><br><span class="line">nginx[<span class="string">'proxy_set_headers'</span>] = &#123;</span><br><span class="line">  <span class="string">"X-Forwarded-Proto"</span> =&gt; <span class="string">"http"</span>,</span><br><span class="line">  <span class="string">"CUSTOM_HEADER"</span> =&gt; <span class="string">"VALUE"</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>Now, execute <code>sudo gitlab-ctl reconfigure</code>. It’ll take some time, depending on the speed of the server. And, if everything goes ok, we should be able to open GitLab client in the browser at <code>https://domain.tld</code>, with a green lock of SSL.</p>
<p>Congratulations!!!</p>
<p>First the browser will be redirected to set the password of the initial administrator account <code>root</code>. Set the password and log into the dashboard by entering the username <code>root</code> and the password you’ve just set. Click on the small range icon to the right hand side of the top bar and then click on the settings icon to left. There you’ll find lot of options to customize. Probably you need to stop the public Sign-up first and use two-factor authentication.</p>
<p>Your server is set-up. Now we have to configure our CI. This is pretty straight forward.</p>
<p>Upload the <code>ssl.crt</code> to the server, intended for the CI. SSH into this server.</p>
<figure class="highlight bash"><table><tr><td class="code"><pre><span class="line">sudo apt-get update</span><br><span class="line">sudo apt-get upgrade</span><br><span class="line"></span><br><span class="line"><span class="comment"># for those, who have configured with self signed </span></span><br><span class="line"><span class="comment"># certificate, following steps are required </span></span><br><span class="line"><span class="built_in">cd</span> /path/to/ssl.crt</span><br><span class="line">sudo cp ssl.crt /etc/ssl/certs/gitlab.pem</span><br><span class="line">sudo cat /etc/ssl/certs/gitlab.pem &gt; /etc/ssl/certs/ca-certificates.crt</span><br></pre></td></tr></table></figure>
<p>First <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/executors/README.md" target="_blank" rel="external">decide</a> about the runner, and follow the <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/install/linux-repository.md" target="_blank" rel="external">steps</a>. There are also some links to important documents <a href="https://gitlab.com/gitlab-org/gitlab-ci-multi-runner/blob/master/docs/executors/README.md" target="_blank" rel="external">here</a>.</p>
<p>Create a new project. Configure <code>.gitlab-ci.yml</code> and enjoy build at every push. Don’t forget to add one badge to the <code>README</code>, will come in the format, <code>![Build Status](https://domain.tld/namespace/project-name/badges/branch-name/build.svg)</code>. </p>
<p>Happy coding. Try to live in your own terms. :-)</p>
</div><!-- comment system--><div class="container"><div id="disqus_thread"></div><script type="text/javascript">
var disqus_shortname = 'coderuse';
var disqus_identifier = '2016/09/Installation-And-Configuration-Of-GitLab-Server-With-CI/';
var disqus_title = "Installation And Configuration Of GitLab Server With CI";
var disqus_url = 'http://coderuse.com/2016/09/Installation-And-Configuration-Of-GitLab-Server-With-CI/';
(function() {
   var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
   dsq.src = '//' + disqus_shortname + '.disqus.com/embed.js';
   (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
})();
</script>
<noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http://disqus.com" class="dsq-brlink">Blog comments powered by <span class="logo-disqus">Disqus</span></a></div></article><div id="footer"><div class="container"><div class="bar"><div class="social"><a href="http://twitter.com/coderuse" target="_blank"><i class="fa fa-twitter"></i></a><a href="https://github.com/coderuse" target="_blank"><i class="fa fa-github"></i></a><a href="https://plus.google.com/+ArnabDasUIDeveloper" target="_blank"><i class="fa fa-google-plus"></i></a><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© <a href="/" rel="nofollow">CodeRuse</a> | <a rel="license" href="http://creativecommons.org/licenses/by/4.0/">Creative Commons Attribution 4.0</a></div></div></div></div><script>var trackID = 'UA-70816071-1', domainID = 'coderuse.com';(function (i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r] || function(){(i[r].q=i[r].q || []).push(arguments);},i[r].l = 1 * new Date();a=s.createElement(o),m=s.getElementsByTagName(o)[0];a.async=1;a.defer=1;a.src=g;m.parentNode.insertBefore(a,m)})(window, document,'script','//www.google-analytics.com/analytics.js','ga');ga('create', trackID, domainID);ga('send', 'pageview');</script></body></html>